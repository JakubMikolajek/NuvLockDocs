<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <title>MQTT Docs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsify/themes/vue.css" />

    <script src="../config.js"></script>

    <script>
      async function sha256hex(str) {
        const enc = new TextEncoder();
        const digest = await crypto.subtle.digest("SHA-256", enc.encode(str));
        return Array.from(new Uint8Array(digest))
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");
      }

      async function auth() {
        const HASH = window.SWAGGER_PW_HASH || "";
        if (!HASH) {
          document.body.innerHTML = "<h2>Brak konfiguracji. Skontaktuj się z administratorem.</h2>";
          return false;
        }

        if (sessionStorage.getItem("mqtt_auth") === "1") return true;

        const pwd = prompt("Wprowadź hasło dostępu do dokumentacji MQTT:");
        if (!pwd) {
          document.body.innerHTML = "<h2>Dostęp anulowany.</h2>";
          return false;
        }

        const h = await sha256hex(pwd);
        if (h !== HASH) {
          document.body.innerHTML = "<h2>Nieprawidłowe hasło.</h2>";
          return false;
        }

        sessionStorage.setItem("mqtt_auth", "1");
        return true;
      }

      window.addEventListener("DOMContentLoaded", async () => {
        const ok = await auth();
        if (!ok) return;

        // dopiero po autoryzacji uruchamiamy Docsify
        window.$docsify = {
          name: "MQTT Docs",
          repo: "",
          loadSidebar: false
        };

        const script = document.createElement("script");
        script.src = "https://cdn.jsdelivr.net/npm/docsify/lib/docsify.min.js";
        document.body.appendChild(script);
      });
    </script>
</head>

<body>
<div id="app"></div>
</body>
</html>
